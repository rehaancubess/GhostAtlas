# Ghostbuster Mode API Fix

## Problem
The Ghostbuster mode verification submission was failing because the Flutter app was sending the wrong data format to the backend API.

## Root Cause
**Mismatch between Flutter and Backend expectations:**

### What Flutter was sending:
```json
{
  "id": "",
  "encounterId": "01HQTEST123",
  "spookinessScore": 4.5,
  "notes": "Very spooky!",
  "verifiedAt": "2024-12-02T10:30:00Z",
  "verificationLocation": {
    "lat": 37.7749,
    "lng": -122.4194
  },
  "isTimeMatched": false
}
```

### What Backend expects:
```json
{
  "location": {
    "latitude": 37.7749,
    "longitude": 122.4194
  },
  "spookinessScore": 4.5,
  "notes": "Very spooky!"
}
```

The backend generates `id`, `encounterId`, `verifiedAt`, `isTimeMatched`, and `distanceMeters` itself.

## Solution

### 1. Updated API Service Method
**File**: `ghostatlas/lib/services/api_service.dart`

**Before**:
```dart
Future<void> verifyEncounter(String id, Verification verification) async {
  await _postWithRetry('/api/encounters/$id/verify', verification.toJson());
}
```

**After**:
```dart
Future<Map<String, dynamic>> verifyEncounter(
  String id,
  LatLng location,
  double spookinessScore, {
  String? notes,
}) async {
  final requestBody = {
    'location': {
      'latitude': location.latitude,
      'longitude': location.longitude,
    },
    'spookinessScore': spookinessScore,
    if (notes != null && notes.isNotEmpty) 'notes': notes,
  };
  
  final response = await _postWithRetry('/api/encounters/$id/verify', requestBody);
  return jsonDecode(response.body);
}
```

### 2. Updated Ghostbuster Mode Screen
**File**: `ghostatlas/lib/screens/ghostbuster_mode_screen.dart`

**Before**:
```dart
final verification = Verification(...); // Created full object
await _apiService.verifyEncounter(widget.encounter.id, verification);
```

**After**:
```dart
final result = await _apiService.verifyEncounter(
  widget.encounter.id,
  _currentLocation!,
  _spookinessScore,
  notes: notes.isEmpty ? null : notes,
);

// Get isTimeMatched from backend response
_isTimeMatched = result['isTimeMatched'] as bool? ?? false;
```

## Improvements

### Better Error Messages
Now shows specific errors based on the failure:
- "You're too far from the location" - When distance > 100m
- "Story not found" - When encounter doesn't exist
- Generic error for other failures

### Validation
- Spookiness score must be between 1-5
- Notes are optional
- Empty notes are not sent to backend

### Backend Response Handling
- Returns `verificationId` and `isTimeMatched`
- `isTimeMatched` is calculated by backend (±2 hours from encounter time)
- Frontend uses backend's time match result for success message

## Backend Validation

The backend `verifyLocation` Lambda validates:
1. **Distance**: Must be within 100 meters of encounter location
2. **Spookiness Score**: Must be 1-5
3. **Coordinates**: Valid latitude/longitude
4. **Notes**: Max 500 characters (if provided)
5. **Time Match**: Automatically checks if within ±2 hours of encounter time

## Flow

```
User at location
├─ Check proximity (50m for UI, 100m for backend)
├─ Fill spookiness score (1-5)
├─ Add optional notes
└─ Submit verification

Flutter sends:
├─ location: {latitude, longitude}
├─ spookinessScore: 4.5
└─ notes: "optional text"

Backend processes:
├─ Validates distance (< 100m)
├─ Validates spookiness score (1-5)
├─ Checks time match (±2 hours)
├─ Generates verification ID
├─ Stores in DynamoDB
├─ Increments encounter verification count
└─ Returns: {verificationId, isTimeMatched}

Flutter shows success:
├─ "Verification Submitted!"
├─ Shows spookiness score
└─ Shows time-matched bonus if applicable
```

## Testing Checklist
- [x] Verification submits successfully
- [x] Distance validation works (100m limit)
- [x] Spookiness score validation (1-5)
- [x] Notes are optional
- [x] Empty notes are not sent
- [x] Time match is calculated by backend
- [x] Success message shows correctly
- [x] Error messages are specific and helpful
- [x] Verification count increments

## Notes
- Frontend checks 50m for UI (to prevent wasted API calls)
- Backend enforces 100m for actual validation
- Time matching is done by backend using UTC time comparison
- Verification ID is generated by backend using ULID
